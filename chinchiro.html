<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チンチロりん♪</title>
    <link rel="stylesheet" href="style.css"> <!-- ★ パスが正しいか確認 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&family=Yuji+Syuku&family=Shippori+Mincho:wght@800&family=RocknRoll+One&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- ===== タイトル画面 ===== -->
    <div id="title-screen" class="screen active">
        <div class="title-content">
            <h1 class="game-title">チンチロりん♪</h1>
            <!-- ↓ 難易度選択を削除し、モード選択を追加 ↓ -->
            <div class="mode-selector">
                <p>モード選択:</p>
                <button class="mode-button button-pop selected" data-mode="normal">通常</button>
                <button class="mode-button button-pop" data-mode="endless">エンドレス</button>
                <button class="mode-button button-pop" data-mode="pvp">対人戦 (準備中)</button>
            </div>
            <!-- ↑ モード選択を追加 ↑ -->
            <button id="start-game-button" class="button-pop">ゲーム開始</button>
            <button id="select-character-button" class="button-subtle">キャラクター選択</button>
            <div class="title-extra-buttons" style="margin-top: 25px; display: flex; justify-content: center; gap: 10px;">
                <!-- 未来のボタン -->
            </div>
        </div>
        <div class="stars"></div>
        <div class="twinkling"></div>
    </div>

    <!-- ===== ゲーム画面 ===== -->
    <div id="game-screen" class="screen"> <!-- ★ 初期は active ではない -->
        <!-- NEW: 上部固定ヘッダー -->
        <header id="game-header">
            <div id="game-coin-info"><h3>所持コイン</h3><p id="game-coin-display">0 G</p></div>
            <div id="settings-button-container">
                 <button id="settings-button" class="button-subtle" style="padding: 5px 10px; font-size: 1.2em;">⚙️</button>
            </div>
        </header>

        <!-- メインコンテナ構造 -->
        <div id="game-main-area">
            <!-- スクロール可能エリア -->
            <div id="game-scrollable-area">
                <div id="game-container">
                    <!-- WAVE情報 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; position: relative;">
                        <div id="wave-info">
                            <!-- JSで内容が表示される -->
                        </div>
                    </div>
                    <div id="current-bet-info" style="min-height: 1.5em; margin-bottom: 15px; font-weight: bold; color: #ffeb3b;">
                        <!-- JSで内容が表示される -->
                    </div>
                    <div id="game-area">
                        <div id="player-info" class="player-box"><h2>あなた <span id="player-parent-marker" class="parent-marker">(親)</span></h2><p class="score-container">持ち点: <span id="player-score" class="score">2500</span></p><p>役/目: <span id="player-hand" class="hand-display">-</span></p><p>サイコロ: <span id="player-dice">-</span></p></div>
                        <div class="character-image-area player"></div>
                        <div id="dice-area">
                            <!-- 通常時のダイス表示（モーダル表示時は隠す） -->
                            <div id="dice-display">- - -</div>
                            <div id="roll-counter" class="roll-counter-top-right">0/3回</div>
                            <!-- 中央アナウンス -->
                            <div id="center-role-announcement" class="center-role"></div>
                            <div id="dice-choice-overlay" class="overlay"></div>
                        </div>
                        <div class="character-image-area npc"></div>
                        <div id="npc-info" class="player-box"><h2>NPC <span id="npc-parent-marker" class="parent-marker">(親)</span></h2><p class="score-container">持ち点: <span id="npc-score" class="score">500</span></p><p>役/目: <span id="npc-hand" class="hand-display">-</span></p><p>サイコロ: <span id="npc-dice">-</span></p></div>
                    </div>
                    <div id="message-area">
                        <p id="message">ゲーム開始！</p>
                        <div id="message-button-container"></div> <!-- ボタン用のコンテナ -->
                    </div>
                </div>
                 <!-- 下部コントロールバーのための余白 (CSSで調整) -->
                 <div id="bottom-spacer"></div>
            </div>

             <!-- 下部固定操作エリア -->
             <div id="bottom-control-bar">
                 <div id="control-area">
                     <!-- 一段目: 入力欄と調整ボタン -->
                     <div class="bet-main-controls">
                         <div class="bet-adjust-container">
                            <button class="bet-adjust-button minus" data-amount="-100">-100</button>
                            <button class="bet-adjust-button minus" data-amount="-10">-10</button>
                         </div>
                         <div class="bet-input-container">
                            <label for="bet-input">賭け金:</label>
                            <input type="number" id="bet-input" min="1" value="10">
                            <span id="min-bet-display">最低: 10</span>
                         </div>
                         <div class="bet-adjust-container">
                            <button class="bet-adjust-button plus" data-amount="10">+10</button>
                            <button class="bet-adjust-button plus" data-amount="100">+100</button>
                         </div>
                     </div>
                     <!-- 二段目: MIN/決定/MAXボタン (順序変更＆MIN追加) -->
                     <div class="bet-action-container">
                        <button id="min-bet-button" class="button-pop min-bet">MIN</button> <!-- MINボタン追加 -->
                        <button id="set-bet-button" class="button-pop set-bet">賭け金決定</button>
                        <button id="max-bet-button" class="button-pop max-bet">MAX</button> <!-- MAXボタンを最後に -->
                     </div>
                     <!-- アクションボタン -->
                     <div id="action-controls">
                        <button id="card-action-button" class="button-subtle">カード</button>
                        <button id="roll-button" class="button-pop" disabled>サイコロを振る</button>
                        <button id="history-button" class="button-subtle">履歴</button>
                    </div>
                     <!-- 次WAVEボタン -->
                     <div id="next-wave-area" style="display: none;">
                         <button id="next-wave-button" class="button-pop">ショップへ</button>
                     </div>
                 </div>
             </div>
        </div>
    </div>

       <!-- ===== ショップ画面 ===== -->
    <div id="shop-screen" class="screen">
        <div class="shop-content">
            <h2 class="shop-title">カードショップ</h2>
            <div id="player-status">
                <div id="coin-display">所持コイン: <span id="player-coins">0</span> G</div>
                <div id="shop-player-hand" class="player-hand-display">
                     手札 (<span id="hand-count">0</span>/8):
                     <ul id="hand-cards"></ul>
                </div>
            </div>
            <p class="shop-message">好きなカードを購入して手札を強化しよう！</p>

            <!-- ↓ #card-offers を削除し、4つのセクションコンテナに変更 ↓ -->
            <div class="shop-offers-container">
                <div class="shop-section">
                    <h4 class="shop-section-title">アクティブカード (使用カード)</h4>
                    <div id="active-card-offers" class="shop-item-row">
                        <!-- JSでアクティブカードがここに挿入される -->
                        <span class="shop-empty-message">(オファーなし)</span> <!-- 初期メッセージ -->
                    </div>
                </div>
                <div class="shop-section">
                    <h4 class="shop-section-title">パッシブカード (装備カード)</h4>
                    <div id="passive-card-offers" class="shop-item-row">
                        <!-- JSでパッシブカードがここに挿入される -->
                         <span class="shop-empty-message">(オファーなし)</span>
                    </div>
                </div>
                <div class="shop-section">
                    <h4 class="shop-section-title">パック</h4>
                    <div id="pack-offers" class="shop-item-row">
                        <!-- JSでパックがここに挿入される -->
                         <span class="shop-empty-message">(オファーなし)</span>
                    </div>
                </div>
                <div class="shop-section">
                    <h4 class="shop-section-title">永続強化</h4>
                    <div id="boost-offers" class="shop-item-row">
                        <!-- JSで追加持ち点アイテムがここに挿入される -->
                         <span class="shop-empty-message">(オファーなし)</span>
                    </div>
                </div>
            </div>

            <div id="shop-actions" class="shop-actions">
                <button id="reroll-button" class="button-subtle"><span class="reroll-icon">↻</span> リロール (<span id="reroll-cost">20</span> G)</button>
                <button id="close-shop-button" class="button-subtle">お店を出る</button>
            </div>
             <div id="shop-confirmation-buttons" class="shop-actions" style="display: none;">
                 <!-- JSで売却確認ボタンがここに追加される -->
             </div>
        </div>
        <div id="discard-modal" class="modal" style="display: none;">
            <div class="modal-content discard-modal-content">
                <h3>手札がいっぱいです！</h3>
                <p>新しいカードを追加するために、売却するカードを選んでください。(売却額: (初期コスト+強化コスト合計)の半額)</p>
                <div id="discard-options"></div>
                <button id="cancel-discard-button" class="button-subtle">キャンセル</button>
            </div>
        </div>
        <div class="stars"></div>
        <div class="twinkling"></div>
    </div>

    <!-- ===== リザルト画面 ===== -->
    <div id="result-screen" class="screen"> <!-- ★ 初期は active ではない -->
        <div class="result-content">
            <h2 id="result-title">ゲームオーバー</h2>
            <p id="result-message">残念！</p>
            <p id="final-score">最終スコア: 0</p>
            <div class="result-actions">
                <button id="restart-same-mode-button" class="button-pop">もう一度遊ぶ</button> <!-- ★ ID変更 -->
                <button id="back-to-title-from-result-button" class="button-subtle">タイトルに戻る</button> <!-- ★ IDとテキスト変更 -->
            </div>
        </div>
        <div class="stars"></div>
        <div class="twinkling"></div>
    </div>

    <!-- ===== キャラクター選択画面 (新規追加) ===== -->
    <div id="character-select-screen" class="screen">
        <div class="character-select-content"> <!-- コンテンツ用ラッパー追加 -->
            <h2>キャラクター選択</h2>
            <div class="character-select-body">
                <div id="character-list">
                    <!-- JSでキャラクターリスト生成 -->
                    <p>キャラクターを選んでください</p>
                </div>
                <div id="character-preview">
                    <p id="character-preview-placeholder">← リストから選択</p>
                    <img id="character-preview-image" src="" alt="キャラクター画像">
                    <p id="character-preview-card" style="margin-top: 15px; color: #ffcc70; font-weight: bold; font-size: 1.1em; display: none;"></p>
                    <div id="character-confirm-area">
                        <p id="character-confirm-message">このキャラクターにしますか？</p>
                        <button id="confirm-character-yes" class="button-pop">はい</button>
                        <button id="confirm-character-no" class="button-subtle">いいえ</button>
                    </div>
                </div>
            </div>
            <button id="back-to-title-button" class="button-subtle">タイトルへ戻る</button>
        </div>
        <div class="stars"></div>
        <div class="twinkling"></div>
    </div>
    <!-- ===== キャラクター選択画面 ここまで ===== -->


    <!-- 履歴モーダル -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="close-history-modal" class="close-button">×</span>
            <h2>ゲーム履歴</h2>
            <ul id="history-log"></ul>
        </div>
    </div>

    <!-- カード一覧モーダル (廃止、設定モーダルに統合) -->
    <!-- <div id="card-list-modal" class="modal"> ... </div> -->

    <!-- サイコロロールモーダル -->
    <div id="dice-roll-modal" class="modal dice-roll-modal">
        <div class="dice-roll-modal-content">
            <span id="close-dice-roll-modal" class="close-button">×</span>
            <div id="dice-roll-modal-display"></div>
        </div>
    </div>

    <!-- ===== 設定モーダル ===== -->
    <div id="settings-modal" class="modal">
        <div class="modal-content settings-modal-content"> <!-- 新しいクラスを追加 -->
            <span id="close-settings-modal" class="close-button">×</span>
            <h2>設定・情報</h2>
            <div class="settings-navigation">
                <button class="settings-nav-button active" data-target="rules">ゲームルール</button>
                <button class="settings-nav-button" data-target="roles">役と点数</button>
                <button id="settings-card-list-button" class="settings-nav-button" data-target="card-list">カード一覧</button> <!-- ★ data-target を追加 -->
                <!-- 他の設定項目ボタンをここに追加可能 -->
            </div>
            <div id="settings-content">
                <!-- ゲームルール -->
                <div id="settings-rules-content" class="settings-tab-content active">
                    <h3>ゲームルール</h3>
                    <ul>
                        <li>CPUのキャラクターを相手に、日本の伝統的なサイコロゲーム「チンチロ」で勝負するゲームです。</li>
                        <li>各WAVEの開始時、どちらかが「親」となり、もう一方が「子」となります（最初はプレイヤーが親）。</li>
                        <li>「親」は、各ラウンドの開始時に「賭け金」を設定します。子は親が設定した賭け金で勝負を受けます。</li>
                        <li>サイコロは3個同時に振り、出た目の組み合わせで「役」が決まります。3回まで振り直せますが、役が出たらその時点で確定です（一部の強い役を除く）。</li>
                        <li>基本的には、「親」が先にサイコロを振り、その後「子」が振ります。役の強さで勝敗が決まります。</li>
                        <li>強い役で勝つと、賭け金が多くもらえます。逆に特定の役（ヒフミなど）を出すと負けとなり、賭け金を多く支払います。</li>
                        <li>「ションベン」（特定の出目）を出すと、その場で負けとなります。3回振っても役も目も出ない「目なし」もションベン扱いです。</li>
                        <li>勝負に勝った方が点数を獲得し、負けた方は点数を失います。親が勝つと連勝となり、獲得点数にボーナスがつきます！</li>
                        <li>親が勝負に負けると、次のラウンドから「親」と「子」が交代します（カード効果で交代を防げる場合もあります）。</li>
                        <li>相手キャラクターの持ち点を0にするか、相手が最低賭け金を払えなくなるとWAVEクリア！</li>
                        <li>WAVEをクリアすると「ショップ」が開き、獲得した「コイン」を使って「カード」を購入・強化できます。</li>
                        <li>カードには、サイコロの目を操作したり、点数を増やしたり、様々な有利な効果があります。手札は最大8枚(アクティブ4/パッシブ4)まで持てます。</li> <!-- ★ 手札上限表示を修正 -->
                        <li>WAVEが進むごとに相手は強くなり、最低賭け金も上がっていきます。</li>
                        <li>プレイヤーの持ち点が0になるか、最低賭け金が払えなくなるとゲームオーバーです。全WAVEクリアを目指しましょう！</li>
                        <li>詳しい役の種類や点数、カードの効果は、それぞれのタブで確認できます。</li>
                    </ul>
                </div>
                <!-- 役と点数 -->
                <div id="settings-roles-content" class="settings-tab-content">
                    <h3>役と点数</h3>
                    <!-- (役と点数の内容は変更なし) -->
                    <div class="score-calculation-info">
                        <h4>基本的な得点の計算方法</h4>
                        <p>各ラウンドの得点（または失点）は、以下の計算式に基づいて決まります。</p>
                        <p class="calculation-formula">
                            <strong>得点</strong> = <strong>基本賭け金</strong> × (<strong>役の基本倍率</strong> + <span class="tooltip" title="アラシ強化、シゴロ強化、各種目ボーナス、報酬増幅、ダブルアップ、ヒフミ/ションベン軽減などのカード効果による倍率の増減です。">カード効果補正</span><span class="formula-part">)</span> × (<span class="formula-part">1</span> + <span class="tooltip" title="親が2連勝以上している場合に加算されます。">連勝ボーナス率</span> + <span class="tooltip" title="「逆境の魂」など、連勝ボーナス率自体を増やすカード効果です。">カード効果補正</span><span class="formula-part">)</span>
                        </p>
                        <p><small>※「一撃保険」など、計算式自体を上書きするカード効果もあります。</small></p>
                        <p><small>※「引き分けボーナス」は引き分け時に別途計算されます。</small></p>
                    </div>
                    <dl>
                        <dt>ピンゾロ (1,1,1)</dt>
                        <dd>最も強い役！ <strong class="payout-win">基本 5倍</strong> の得点を獲得。</dd>
                        <dd class="card-effect-rate">（現在のカード効果込み倍率: <span id="role-rate-pinzoro">5</span>倍）</dd>
                        <dt>アラシ (ゾロ目 2〜6)</dt>
                        <dd>ゾロ目の役。数字が大きいほど強い (6ゾロ > ... > 2ゾロ)。<strong class="payout-win">基本 3倍</strong> の得点を獲得。</dd>
                        <dd class="card-effect-rate">（現在のカード効果込み倍率: <span id="role-rate-arashi">3</span>倍）</dd>
                        <dt>シゴロ (4,5,6)</dt>
                        <dd>4,5,6の組み合わせ。<strong class="payout-win">基本 2倍</strong> の得点を獲得。</dd>
                        <dd class="card-effect-rate">（現在のカード効果込み倍率: <span id="role-rate-shigoro">2</span>倍）</dd>
                        <dt>通常の目 (例: 2,2,5 なら「5の目」)</dt>
                        <dd>同じ数字2つと異なる数字1つの組み合わせ。異なる数字が大きいほど強い (6の目 > ... > 1の目)。相手の目と比べて数字が大きい方が勝ち。<strong class="payout-win-normal">基本 1倍</strong> の得点（または失点）。</dd>
                        <dd class="card-effect-rate">（1の目勝利時倍率: <span id="role-rate-eye1">1</span>倍 / 6の目勝利時倍率: <span id="role-rate-eye6">1</span>倍）</dd>
                        <dt>ヒフミ (1,2,3)</dt>
                        <dd>1,2,3の組み合わせ。役の中では一番弱いがションベンよりは強い。 <strong class="payout-lose">基本 2倍</strong> の失点。</dd>
                        <dd class="card-effect-rate">（現在のカード効果込み支払い倍率: <span id="role-rate-hifumi">2</span>倍）</dd>
                        <dt>ションベン</dt>
                        <dd>サイコロが器の外に出るなどした場合の反則負け。3回振って役も目も出ない「目なし」も最終的にションベン扱い。<strong class="payout-lose">基本 1倍</strong> の失点。</dd>
                        <dd class="card-effect-rate">（現在のカード効果込み支払い倍率: <span id="role-rate-shonben">1</span>倍）</dd>
                        <dt>目なし</dt>
                        <dd>3つのサイコロの数字が全てバラバラで、かつヒフミ(123)やシゴロ(456)ではない場合。ペナルティはなく、<strong class="payout-neutral">再度振り直せる</strong>（最大ロール回数まで）。</dd>
                        <dt>引き分け</dt>
                        <dd>相手と同じ強さの役・目を出した場合。基本的には<strong class="payout-neutral">得点変動なし</strong>。（カード効果でボーナスあり）</dd>
                        <dt>★連勝ボーナス</dt>
                        <dd>親が勝利した場合、<strong class="payout-win">その勝利から</strong>獲得/支払い得点が10%ずつ増加します (例: 親1勝目で+10%, 親2連勝目で+20%...)。（カード効果でさらに増加する場合あり）</dd>
                        <dt>★親交代</dt>
                        <dd>親が勝負に<strong class="payout-lose">負けた</strong>場合、次のラウンドから親と子が交代します。（カード効果で維持できる場合あり）</dd>
                    </dl>
                </div>
                <!-- ★ カード一覧タブのコンテンツエリアを追加 ★ -->
                <div id="settings-card-list-content" class="settings-tab-content">
                    <h3>カード一覧</h3>
                    <div id="settings-card-list-inner">
                        <!-- JSでカードリストが生成される -->
                    </div>
                </div>
                <!-- 他のタブコンテンツがここに追加される可能性 -->
            </div> <!-- /#settings-content -->
        </div> <!-- /.modal-content -->
    </div> <!-- /#settings-modal -->

    <!-- ===== カード画面モーダル ===== -->
    <div id="card-action-modal" class="modal">
        <div class="modal-content card-action-modal-content">
            <span id="close-card-action-modal" class="close-button">×</span>
            <h2>手札のカード</h2>

            <!-- アクティブカードセクション -->
            <div class="card-section">
                <h3>アクティブカード</h3>
                <p id="active-card-message" class="card-section-message">使用したいカードを選択してください。</p>
                <div id="active-card-display" class="card-display-area">
                    <!-- JSでアクティブカードがここに挿入される -->
                </div>
            </div>

            <!-- パッシブカードセクション -->
            <div class="card-section">
                <h3>パッシブカード (装備カード)</h3>
                <p id="passive-card-message" class="card-section-message">現在装備中のカードです。</p>
                <div id="passive-card-display" class="card-display-area">
                    <!-- JSでパッシブカードがここに挿入される -->
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>